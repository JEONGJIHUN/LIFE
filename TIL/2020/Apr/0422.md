# TIL

## Sorting Arrays in JavaScript

백엔드 개발자분들이 python 에서 사용하는 sort 는 무슨 알고리즘을 사용하는지에 대한 대화가 오고 갔을 때, 나는 자바스크립트는 무슨 알고리즘을 쓸까하는 궁금증에 찾아보게 되었다.
Built-in Method 인 `sort` 는 브라우저마다 결과는 같지만, 각기 다른 정렬 알고리즘을 사용한다고 한다.

- V8: Quicksort or Insertion Sort (for smaller arrays)
- Firefox: Merge sort
- Safari: Quicksort, Merge Sort, or Selection Sort (depending on the type of array)

## Performance optimization Part.1

성능 최적화에 항상 관심을 가지고 있었지만 아직 제대로 해볼 기회가 없었다. 하지만 이론부터 정리해두면 좋을 것 같아 [toast ui 성능 최적화](https://ui.toast.com/fe-guide/ko_PERFORMANCE/) 를 참고해 요약해보려 한다.

### 브라우저 로딩 과정

1. 파싱

파싱은 다운로드한 HTML을 해석하여 DOM 트리를 구성하는 단계이다. DOM 트리 구성 및 CSSOM 트리를 구성해 스타일을 매칭시켜주고 나면 렌더 트리를 구성한다.

2. 레아아웃

노드의 정확한 위치와 크기를 계산한다. 루트부터 노드를 순회하면서 게산하며 위치와 크기를 픽셀값을 렌더트리에 반영한다.(만약 CSS에서 크기 값을 %로 지정하였다면, 레이아웃 단계를 거친 후 % 값은 계산되고 측정 가능한 픽셀 단위로 변환된다.)

3. 페인트

레이아웃에서 계산된 값을 이용해 각 노드를 화면상의 실제 픽셀로 변환한다. 이 때 위치와 관계없는 색상, 투명도 등을 적용한다. transform 속성 등을 사용하면 엘리먼트가 레이어화 되는데, 이 과정을 페인트라고 한다.

4. 합성 & 렌더

페인트 단계에서 생성된 레이어를 합성하여 스크린을 업데이트한다. 합성과 렌더 단계가 끝나면 화면에서 웹 페이지를 볼 수 있다.

### 레이아웃과 리페인트

브라우저 로딩 과정 중 스타일 이후의 과정(스타일 -> 레이아웃 -> 페인트 -> 합성)을 렌더링이라고 하는데, 이 렌더링 과정은 상황에 따라 반복하여 발생할 수 있다. 스타일 단계에서 구성되는 렌더 트리는 자바스크립트에 의해 DOM 트리, CSSOM 트리가 변경될 때 다시 재구성된다. DOM이 추가/삭제되거나 요소에 기하적인 영향(높이, 넓이, 위치)을 주는 CSS 속성값을 변경하는 경우, 렌더 트리가 다시 재구성된다. **즉, 레이아웃부터 이후 과정을 다시 수행하며 이것을 레이아웃(리플로우)이라고 한다.** 레이아웃은 요소에 기하적인 영향을 주는 CSS 속성값을 변경할 때 발생한다고 하였는데, **반대로 영향을 주지 않는 CSS 속성값을 변경하면 레이아웃 과정을 건너뛴다. 페인트부터 수행하며 이를 리페인트라고 한다.**
레이아웃이 일어나면 전체 픽셀을 다시 계산해야 하므로 부하가 크다. 반면 리페인트는 이미 계산된 픽셀값을 이용해 화면을 그리기 때문에 레이아웃에 비해 부하가 적다. 다음은 어떤 엘리먼트에 레이아웃과 리페인트를 발생시키는 CSS 속성과 해당 속성값을 변경했을 때 차이를 보여준다.

- 레이아웃(리플로우)에 영향을 주는 CSS 속성값 : height, width, left, top, font-size, line-height 등
- 리페인트에 영향을 주는 CSS 속성값 : background-color, color, visibility, text-decoration 등

### 블록 리소스와 렌더링 경로

브라우저 로딩 초기 단계에서 HTML 파싱이 일어날 때 CSS 또는 자바스크립트로 인해 파싱이 중단될 수 있다. 이렇게 파싱이 중단되는 상황을 HTML 파싱이 블록되었다라고 표현하며, 블록 상태의 원인이 되는 리소스를 블록 리소스(Block resource) 라고 부른다. 블록 리소스는 브라우저 로딩 단계 중 페인트 과정을 지연시키므로, 블록 리소스가 HTML 파싱을 막는 상황이 발생하지 않도록 해야 한다. 구글에서는 주요 렌더링 경로(Critical Rendering Path)를 최적화하면 페인팅을 빠르게 하고 로딩 속도를 개선할 수 있다고 설명한다.

#### 성능 개선 지표

성능 지표의 측정 기준은 크게 **브라우저**와 **사용자** 입장으로 나눌 수 있다. 기준별로 어떤 차이가 있는지 알아보고, 성능 측정에 사용되는 지표를 알아본다.

1. 브라우저 기준의 성능 측정

전통적인 성능 측정 방식은 브라우저에서 발생하는 이벤트를 사용하는 것이었다. 웹 페이지가 로딩될 때 DOMContentLoaded, load 이벤트가 발생하며, 각 이벤트가 발생하는 시점으로 성능을 측정하게 된다. 이 모델에서 DOMContentlLoaded 이벤트, load 이벤트 발생 시점이 빠를수록, 그리고 두 이벤트 발생 구간의 폭이 좁을수록 성능이 좋다고 말한다.

**DOMContentLoaded 이벤트**

- HTML과 CSS 파싱이 끝나는 시점
- 렌더 트리를 구성할 준비가 된(DOM 및 CSSOM 구성이 끝난) 상황

**load 이벤트**

- HTML 상에 필요한 모든 리소스가 로드된 시점

        크롬 개발자 도구는 브라우저에서 이벤트 발생 시점을 확인할 수 있도록 UI를 제공하고 다양한 측정 방법을 제공한다.

#### 사용자 기준의 성능 측정

개발 패러다임이 변화하면서 DOMContentLoaded, load 이벤트 발생 시점만 가지고 성능을 판단하기 어려워졌다. 최근에 많이 사용되는 SPA(Single Page Application)에서는 웹 페이지에 포함된 적은 양의 HTML로 DOMContentLoaded, load 이벤트가 일찍 발생할 수 있으나, 이벤트가 발생한 이후에도 수많은 스크립트 실행으로 인해 여전히 "느린 로딩"이 존재한다. 이러한 이유로 사용자 기준의 새로운 성능 측정 방식이 필요하게 되었다.

사용자 기준의 성능 측정은 사용자에게 콘텐츠를 보여주는 여러 시점을 기반으로 한다. 의미 있는 콘텐츠가 처음 보이는 시점이 빠를수록 성능이 좋다고 판단하며, 이 시점을 앞당길 수 있도록 최적화해야 한다. 최적화가 잘 된 경우, 콘텐츠 일부분이 보이고 이후 점진적으로 모든 콘텐츠가 화면에 출력된다. 반면 최적화가 안 된 경우, 흰 화면만 보이다가 모든 콘텐츠가 보인다.

**FP(First Paint)**

- 흰 화면에서 화면에 무언가가 처음으로 그려지기 시작하는 순간이다.

**FCP(First Contentful Paint)**

- 텍스트나 이미지가 출력되기 시작하는 순간이다.

**FMP(First Meaningful Paint)**

- 사용자에게 의미 있는 콘텐츠가 그려지기 시작하는 첫 순간이다. 콘텐츠를 노출하는데 필요한 CSS, 자바스크립트 로드가 시작되고 스타일이 적용되어 주요 콘텐츠를 읽을 수 있다.

**TTI(Time to Interactive)**

- 자바스크립트의 초기 실행이 완료되어서 사용자가 직접 행동을 취할 수 있는 순간이다.

**성능 측정 도구**

크롬 브라우저에서는 개발자 도구를 제공하며, 이 개발자 도구를 사용해 지금까지 설명한 내용을 눈으로 확인해볼 수 있다. 크롬 개발자 도구에서 성능과 관련된 패널로 Network, Performance, Audits가 있다.

**Performance 패널**

Performance 패널에서는 앞서 살펴본 웹 페이지 로딩 단계를 차트 형태로 살펴볼 수 있다. 웹 페이지가 로드되는 과정을 레코딩하고 단계마다 걸리는 시간을 확인할 수 있다. 로딩 과정에서 최적화가 필요한 부분을 찾을 때 사용한다.

**Network 패널**

Network 패널에서는 웹 페이지가 로딩되는 동안 요청된 리소스의 상태를 차트 형태로 확인할 수 있으며, 리소스 최적화 상태를 비교할 때 사용한다. Performance 패널과 같이 레코딩하고, 레코딩이 끝나면 Overview와 Request Table에 리소스 요청 정보가 나타난다. 이때 리소스 목록은 시간순으로 정렬된다. 그리고 차트 부분을 선택하면 각 리소스의 서버 요청 대기 시간을 자세히 볼 수 있다. 또한 패널 하단에 DOMContentLoaded, load 이벤트 발생 시간이 출력된다.

**Audits 패널**

Audits 패널에서는 사용자 기준의 성능 측정 지표를 확인할 수 있다. 화면은 크게 성능 측정 전/후로 나뉘는데, 측정 전 화면에서는 어떤 환경에서 성능을 측정할지 선택할 수 있다. 느린 네트워크 환경의 시뮬레이션이 필요하다면 Throttling 영역을 설정한다. Run audits 버튼을 클릭하면 성능 측정이 시작되며 측정 후 결과 화면을 보여준다.

다음 장은 위의 내용을 바탕으로 로딩 과정 최적화를 살펴볼 것이다.
`
